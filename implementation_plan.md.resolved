# Plan de Implementaci√≥n: Chat Instant√°neo y Soporte Multimedia

Este documento detalla los pasos t√©cnicos exactos para implementar las nuevas mejoras, bas√°ndonos en la arquitectura actual verificada.

## ‚úÖ Confirmaciones Previas
1.  **Session IDs:** Ya tenemos IDs √∫nicos generados autom√°ticamente en [chatStore.ts](file:///c:/Developer/Widget%20soporte/chat-widget/src/store/chatStore.ts) (ej: `session_1739...`). No necesitamos crear esta l√≥gica, solo aprovecharla.
2.  **Almacenamiento:** Usaremos el servidor local (`/uploads` en `chat-api`) para guardar im√°genes, audios y videos.
3.  **Componentes:** El formulario de tel√©fono actual es [PhoneCapture.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/PhoneCapture.tsx).

---

## Fase 1: Backend - Infraestructura de Archivos ‚öôÔ∏è
**Objetivo:** Permitir que la API reciba y guarde archivos.

#### 1.1 Configurar Multer (Gestor de Archivos)
-   **Archivo:** `chat-api/src/config/multer.ts` (Nuevo)
-   **Acci√≥n:** Configurar almacenamiento en disco.
    -   Carpeta destino: `./uploads` (se crear√° autom√°ticamente).
    -   Nombres de archivo: `timestamp-originalName` (para evitar duplicados).
    -   Filtros: Aceptar im√°genes (jpg, png, wepb), audio (mp3, wav, webm) y video (mp4).

#### 1.2 Exponer Carpeta P√∫blica
-   **Archivo:** [chat-api/src/app.ts](file:///c:/Developer/Widget%20soporte/chat-api/src/app.ts)
-   **Acci√≥n:** Agregar l√≠nea para servir archivos est√°ticos:
    -   `app.use('/uploads', express.static('uploads'));`
-   **Resultado:** Los archivos ser√°n accesibles en `http://servidor:puerto/uploads/archivo.jpg`.

#### 1.3 Nuevo Endpoint de Subida
-   **Archivo:** [chat-api/src/routes/chat.routes.ts](file:///c:/Developer/Widget%20soporte/chat-api/src/routes/chat.routes.ts)
-   **Acci√≥n:** Crear ruta `POST /upload`.
    -   Usa middleware `upload.single('file')`.
    -   Retorna: `{ success: true, url: '...', type: 'image/jpeg' }`.

---

## Fase 2: Frontend - Chat Instant√°neo y Multimedia üöÄ
**Objetivo:** Eliminar el bloqueo inicial y permitir env√≠os multimedia.

#### 2.1 Eliminar Barrera de Entrada ("Chat Instant√°neo")
-   **Archivo:** [chat-widget/src/components/ChatWindow.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/ChatWindow.tsx)
-   **Acci√≥n:**
    -   Buscar la condici√≥n que muestra `<PhoneCapture />`.
    -   Modificarla para que **NO** bloquee la vista del chat.
    -   El usuario podr√° ver y escribir mensajes desde el segundo 0 usando su `sessionId` autom√°tico.

#### 2.2 UI de Mensajes Multimedia
-   **Archivo:** [chat-widget/src/components/MessageList.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/MessageList.tsx)
-   **Acci√≥n:** Actualizar el renderizado de mensajes.
    -   Si `message.type === 'image'`: Mostrar etiqueta `<img>`.
    -   Si `message.type === 'video'`: Mostrar etiqueta `<video>`.
    -   Si `message.type === 'audio'`: Mostrar etiqueta `<audio>` o reproductor simple.

#### 2.3 Botones de Adjuntar
-   **Archivo:** [chat-widget/src/components/MessageInput.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/MessageInput.tsx)
-   **Acci√≥n:**
    -   Agregar bot√≥n "Clip" üìé (Input file oculto) para im√°genes/videos.
    -   Agregar bot√≥n "Micr√≥fono" üéôÔ∏è para grabar audio (usando `MediaRecorder` API del navegador).
    -   L√≥gica de env√≠o:
        1. Subir archivo al endpoint `/api/chat/upload`.
        2. Al recibir la URL, enviar mensaje por Socket con `{ type: 'image', content: 'url...' }`.

---

## Fase 3: Integraci√≥n con n8n üß†
**Objetivo:** Que el cerebro entienda los nuevos tipos de mensaje.

#### 3.1 Actualizar "Message Router" en n8n
-   **Acci√≥n:** Modificar tu workflow actual para manejar tipos.
    -   **Nodo Switch:**
        -   Ruta 0 (Texto): Flujo actual con Gemini.
        -   Ruta 1 (Imagen): Nodo "Gemini Vision" (analiza la imagen).
        -   Ruta 2 (Audio): Nodo "Whisper" (transcribe a texto).
    -   El Frontend enviar√° el campo `type` en el JSON, lo usaremos para filtrar.

## Resumen de Archivos a Tocar
1.  [chat-api/src/app.ts](file:///c:/Developer/Widget%20soporte/chat-api/src/app.ts) (Servir uploads)
2.  [chat-api/package.json](file:///c:/Developer/Widget%20soporte/chat-api/package.json) (Instalar multer)
3.  [chat-widget/src/components/ChatWindow.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/ChatWindow.tsx) (Quitar PhoneCapture)
4.  [chat-widget/src/components/MessageInput.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/MessageInput.tsx) (Botones media)
5.  [chat-widget/src/components/MessageList.tsx](file:///c:/Developer/Widget%20soporte/chat-widget/src/components/MessageList.tsx) (Ver fotos/videos)
